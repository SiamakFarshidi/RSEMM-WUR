{% load static %}

<html lang="en">

<head>
    <title>Loading...</title>
    <!-- HTML5 Shim and Respond.js IE9 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Meta -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="description" content="The Decision Support System (DSS) leverages AI to enhance decision-making in research, software engineering, and project management. Designed for complex problem-solving, DSS provides tools for feature prioritization, evaluation, and visualization to support data-driven decisions." />
    <meta name="keywords" content="AI decision support, Decision Support System, DSS, AI for research, software engineering, project management, feature prioritization, AI-powered decision-making, research tools, engineering decision support, data-driven decisions" />

    <meta name="author" content="codedthemes">
    <!-- Favicon icon -->
    <link rel="icon" href="{% static '/img/wurlogo.png'%}" type="image/x-icon">
    <!-- Google font-->
    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600" rel="stylesheet">
    <!-- Required Fremwork -->
    <link rel="stylesheet" type="text/css" href="{% static '/css/bootstrap/css/bootstrap.min.css'%}">
    <!-- themify-icons line icon -->
    <link rel="stylesheet" type="text/css" href="{% static '/icon/themify-icons/themify-icons.css'%}">
    <link rel="stylesheet" type="text/css" href="{% static '/icon/font-awesome/css/font-awesome.min.css'%}">

    <!-- ico font -->
    <link rel="stylesheet" type="text/css" href="{% static '/icon/icofont/css/icofont.css'%}">
    <!-- Style.css -->
    <link rel="stylesheet" type="text/css" href="{% static '/css/style.css'%}">
    <link rel="stylesheet" type="text/css" href="{% static '/css/jquery.mCustomScrollbar.css'%}">
    <link rel="stylesheet" href="{% static '/notification/style.css'%}" />
    <script src="{% static '/notification/cute-alert.js'%}"></script>
    <link rel="stylesheet" type="text/css" href="{% static '/starRating/starability-minified/starability-all.min.css'%}" />


    <!-- all DSS pages need this section -->
    <link rel="stylesheet" type="text/css" href="{% static '/css/dss-menu-items.css'%}">
    <script>
        const menuJsonUrl = "{% static 'DSS-config/menu.json' %}";
    </script>
    <script src="{% static 'js/dss-menu-items.js' %}"></script>
    <!------------------------------------->
    <!-- JSONEditor for nice JSON visualization -->
    <link href="https://cdn.jsdelivr.net/npm/jsoneditor@9.10.0/dist/jsoneditor.min.css" rel="stylesheet" type="text/css">
    <script src="https://cdn.jsdelivr.net/npm/jsoneditor@9.10.0/dist/jsoneditor.min.js"></script>

    <style>
        body {
            font-family: 'Poppins', 'Helvetica Neue', Arial, sans-serif;
            font-size: 12px;
            line-height: 1.6;
            color: #212529;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', 'Helvetica Neue', Arial, sans-serif;
            font-weight: 600;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 700;
        }

        .table th, .table td {
            font-size: 0.8rem;
            font-family: 'Poppins', 'Helvetica Neue', Arial, sans-serif;
        }

        #result {
            border: 0px;
            background-color: white;
            padding: 0px;
            margin: 0px;
        }

        /* Main content area — wider */
        .pcoded-main-container .pcoded-wrapper main {
            max-width: 1800px; /* Wider main content area */
            margin: 0 auto;
            padding: 2rem;
            box-sizing: border-box;
        }

        /* Card — wider */
        .card {
            width: 100%;
            max-width: 1600px; /* Wider card */
            margin: 0 auto;
        }

        /* Estimator — wider and centered */

        /* Desktop */
        @media (min-width: 992px) {
            #estimator {
                max-width: 1200px; /* Wider estimator */
                margin-left: calc(250px + (100% - 250px - 1200px) / 2);
                transition: margin-left 0.3s ease;
            }
        }

        /* Mobile */
        @media (max-width: 991.98px) {
            #estimator {
                max-width: 100%; /* full width on mobile */
                margin: 0 auto;
                padding-left: 1rem;
                padding-right: 1rem;
            }
        }

    </style>



</head>

<body>
    <div id="searchLoadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 10000000 !important;">
        <canvas id="searchNetworkCanvas" style="display: block; margin: 0; background: transparent;"></canvas>
        <p id="searchTypingMessage" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></p>
    </div>

    <!-- Pre-loader start -->
    <div class="theme-loader">
        <div class="loader-track">
            <div class="loader-bar"></div>
        </div>
    </div>
    <!-- Pre-loader end -->
    <div id="pcoded" class="pcoded">
        <div class="pcoded-overlay-box"></div>
        <div class="pcoded-container navbar-wrapper">

            <nav class="navbar header-navbar pcoded-header">
                <div class="navbar-wrapper">
                    <div class="navbar-logo">
                        <a class="mobile-menu" id="mobile-collapse" href="#!">
                            <i class="ti-menu"></i>
                        </a>
                        <div class="mobile-search">
                            <div class="header-search">
                                <div class="main-search morphsearch-search">
                                    <div class="input-group">
                                        <span class="input-group-addon search-close"><i class="ti-close"></i></span>
                                        <input type="text" class="form-control" placeholder="Enter Keyword">
                                        <span class="input-group-addon search-btn"><i class="ti-search"></i></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <a href="/">
                            <img class="img-fluid responsive-logo" src="{% static '/img/wurlogo.png' %}" style="width:65px; padding:6px;margin-top:-5px;" alt="Theme-Logo" />
                        </a>
                        <a class="mobile-options">
                            <i class="ti-more"></i>
                        </a>
                    </div>

                    <div class="navbar-container container-fluid">
                        <ul class="nav-left">
                            <li>
                                <div class="sidebar_toggle"><a href="javascript:void(0)"><i class="ti-menu"></i></a></div>
                            </li>
                            <li class="header-search">
                                <div class="main-search morphsearch-search">
                                    <div class="input-group">
                                        <span class="input-group-addon search-close"><i class="ti-close"></i></span>
                                        <input type="text" class="form-control" id="searchbox1" name="searchbox1" onchange="search(1);">
                                        <span class="input-group-addon search-btn"><i class="ti-search"></i></span>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <a href="#!" onclick="javascript:toggleFullScreen()">
                                    <i class="ti-fullscreen"></i>
                                </a>
                            </li>
                        </ul>
                        <ul class="nav-right">

                            <li class="user-profile header-notification">
                                <a href="#!">
                                    <img src="{% static 'images/GuestICON.png' %}" class="img-radius" alt="User-Profile-Image">
                                    <span>Guest</span>
                                    <i class="ti-angle-down"></i>
                                </a>
                                <ul class="show-notification profile-notification">
                                    <li><a href="../accountManagement/login"><i class="ti-layout-sidebar-left"></i> Login </a> </li>

                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>

            <div class="pcoded-main-container">
                <div class="pcoded-wrapper">
                    <nav class="pcoded-navbar">
                        <div class="sidebar_toggle"><a href="#"><i class="icon-close icons"></i></a></div>
                        <div class="pcoded-inner-navbar main-menu" id="dynamic-menu">
                            <!-- Menu items will be injected here by JavaScript -->
                        </div>
                    </nav>



                    <!-- Main Content Section -->
                    <main class="container-fluid px-3 px-md-5 mt-5">
                        <section id="estimator" class="py-5">
                            <div class="row justify-content-center">
                                <div class="col-lg-12 col-xl-12 col-md-12">
                                    <div class="card shadow-sm rounded-3">
                                        <div class="card-body p-5">

                                            <!-- Header -->
                                            <h2 class="card-title text-center fw-bold mb-3">Project Maturity Estimator</h2>
                                            <p class="card-text text-center text-muted mb-4">
                                                Paste a Zenodo link below to gauge your project’s maturity level.
                                            </p>

                                            <!-- Form -->
                                            <form id="maturity-form" novalidate>
                                                {% csrf_token %}

                                                <div class="form-floating mb-4">
                                                    <input type="url"
                                                           class="form-control"
                                                           id="repo-url"
                                                           name="repo_url"
                                                           placeholder="https://zenodo.org/record/XXXXXXX"
                                                           required>
                                                    <label for="repo-url">Repository / DOI URL</label>
                                                    <div class="invalid-feedback">
                                                        Please enter a valid GitHub or Zenodo URL.
                                                    </div>
                                                </div>

                                                <button type="submit" class="btn btn-primary btn-lg w-100 py-2">
                                                    <i class="fas fa-rocket me-2"></i>
                                                    <span>Estimate Maturity</span>
                                                </button>
                                            </form>


                                            <!-- Dashboard (hidden until results arrive) -->
                                            <div id="dashboard" class="mt-4 d-none">
                                                <div id="result"></div>

                                                <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
                                                    <li class="nav-item" role="presentation">
                                                        <button class="nav-link active" id="se-tab" data-bs-toggle="tab" data-bs-target="#se"
                                                                type="button" role="tab">
                                                            SE Efforts  <a target="_blank" href="https://drive.google.com/file/d/1WgeZERUQWGncEGIuPXbCK3u8Xv8bV2yr/view?usp=sharing"><i class="fas fa-info-circle"></i> </a>
                                                        </button>
                                                    </li>
                                                    <li class="nav-item" role="presentation">
                                                        <button class="nav-link" id="fair-tab" data-bs-toggle="tab" data-bs-target="#fair"
                                                                type="button" role="tab">
                                                            FAIR Assessment <a target="_blank" href="https://drive.google.com/file/d/1oKIXlac4u7CNygtj7ODNFsZoexphMsxU/view?usp=sharing"><i class="fas fa-info-circle"></i> </a>
                                                        </button>
                                                    </li>
                                                    <li class="nav-item" role="presentation">
                                                        <button class="nav-link" id="cg-tab" data-bs-toggle="tab" data-bs-target="#cg"
                                                                type="button" role="tab">
                                                            Code Gen Evaluation <a target="_blank" href="https://drive.google.com/file/d/1djyIGMAG6XY6tJnNBdy_535Hbd_qQ2CE/view?usp=sharing"><i class="fas fa-info-circle"></i> </a>
                                                        </button>
                                                    </li>
                                                    <li class="nav-item" role="presentation">
                                                        <button class="nav-link" id="aiops-tab" data-bs-toggle="tab" data-bs-target="#aiops"
                                                                type="button" role="tab">
                                                            AI/ML/Ops <a target="_blank" href="https://drive.google.com/file/d/1dfrFzsGUcRsb7ZnIi6bExmgftJAD9-Xy/view?usp=sharing"><i class="fas fa-info-circle"></i> </a>
                                                        </button>
                                                    </li>

                                                    <li class="nav-item" role="presentation">
                                                        <button class="nav-link" id="detailed-tab" data-bs-toggle="tab" data-bs-target="#detailed"
                                                                type="button" role="tab">
                                                            Detailed Estimation (JSON)
                                                        </button>
                                                    </li>
                                                </ul>

                                                <div class="tab-content border border-top-0 p-4">
                                                    <!-- Software Engineering Efforts -->
                                                    <div class="tab-pane fade show active" id="se" role="tabpanel">
                                                        <table class="table table-striped">
                                                            <tbody>
                                                                <tr><th>Zenodo URL</th><td id="zenodo-url-cell"></td></tr>
                                                                <tr><th>GitHub URL</th><td id="github-url-cell"></td></tr>
                                                                <tr><th>Community</th><td id="community-cell"></td></tr>
                                                                <tr><th>CI</th><td id="ci-cell"></td></tr>
                                                                <tr><th>Documentation</th><td id="documentation-cell"></td></tr>
                                                                <tr><th>History</th><td id="history-cell"></td></tr>
                                                                <tr><th>Issues</th><td id="issues-cell"></td></tr>
                                                                <tr><th>License</th><td id="license-cell"></td></tr>
                                                                <tr><th>Unit Tests</th><td id="unittest-cell"></td></tr>
                                                            </tbody>
                                                        </table>

                                                    </div>
                                                    <!-- Code Gen Evaluation -->
                                                    <div class="tab-pane fade" id="cg" role="tabpanel">
                                                        <table class="table table-striped">
                                                            <tbody>
                                                                <tr><th>Code Gen Estimation</th><td id="codegen-cell"></td></tr>
                                                                <tr><th>AI Detected</th><td id="ai-detected-cell"></td></tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    <!-- AI/ML/Ops -->
                                                    <div class="tab-pane fade" id="aiops" role="tabpanel">
                                                        <table class="table table-striped">
                                                            <tbody>
                                                                <tr><th>Category</th><td id="category-cell"></td></tr>
                                                                <tr><th>Types</th><td id="types-cell"></td></tr>
                                                            </tbody>
                                                        </table>

                                                    </div>
                                                    <!-- FAIR Assessment -->
                                                    <div class="tab-pane fade" id="fair" role="tabpanel">
                                                        <table class="table table-striped">
                                                            <tbody>
                                                                <tr><th>Findable</th><td id="findable-cell"></td></tr>
                                                                <tr><th>Accessible</th><td id="accessible-cell"></td></tr>
                                                                <tr><th>Interoperable</th><td id="interoperable-cell"></td></tr>
                                                                <tr><th>Reusable</th><td id="reusable-cell"></td></tr>
                                                                <tr><th>Overall Fairness</th><td id="overall-fairness-cell"></td></tr>
                                                                <tr><th>HowFairIs Score</th><td id="howfairis-cell"></td></tr>
                                                            </tbody>
                                                        </table>

                                                    </div>
                                                    <!-- detailed estimation -->
                                                    <div class="tab-pane fade" id="detailed" role="tabpanel">
                                                        <div id="jsoneditor" style="height: 500px; border: 1px solid #ccc; border-radius: .5rem;"></div>
                                                    </div>
                                                   
                                                </div>
                                            </div>


                                            <!-- List of Stored Zenodo Records -->
                                            <section id="stored-records" class="mt-5">
                                                <h5>Stored Zenodo Records</h5><br />
                                                <table id="stored-records-table" class="table table-striped table-bordered" style="width:100%">
                                                    <thead>
                                                        <tr>
                                                            <th>Load</th>
                                                            <th>Zenodo</th>
                                                            <th>GitHub</th>
                                                            <th>Title</th>
                                                            <th>Authors</th>
                                                            <th>Affiliations</th>
                                                            <th>Topics (Keywords)</th>
                                                            <th>Score</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <!-- Filled dynamically -->
                                                    </tbody>
                                                </table>
                                            </section>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </main>


                    <!-- Main Content Section -->


                </div>
            </div>
        </div>
    </div>


    <!-- Add this just before the closing body tag in index.html -->
    <div id="loadingSpinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>

    {% csrf_token %}

    <script type="text/javascript" src="{% static 'js/jquery/jquery.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/jquery-ui/jquery-ui.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/popper.js/popper.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/bootstrap/js/bootstrap.min.js' %}"></script>
    <!-- jquery slimscroll js -->
    <script type="text/javascript" src="{% static 'js/jquery-slimscroll/jquery.slimscroll.js' %}"></script>
    <!-- modernizr js -->
    <script type="text/javascript" src="{% static 'js/modernizr/modernizr.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/modernizr/css-scrollbars.js' %}"></script>

    <!-- Custom js -->
    <script type="text/javascript" src="{% static 'js/script.js' %}"></script>
    <script src="{% static 'js/pcoded.min.js' %}"></script>
    <script src="{% static 'js/vartical-demo.js' %}"></script>
    <script src="{% static 'js/jquery.mCustomScrollbar.concat.min.js' %}"></script>

    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
            crossorigin="anonymous"></script>

    <script>
        // Helper to grab CSRF token from cookie
        function getCookie(name) {
            const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
            return v ? v.pop() : '';
        }
        const csrftoken = getCookie('csrftoken');

        (function () {
            const form = document.getElementById('maturity-form');
            const urlInput = document.getElementById('repo-url');
            const spinner = document.getElementById('spinner');
            const dashboard = document.getElementById('dashboard');
            const resultBox = document.getElementById('result');

            // map your JSON response keys → cell IDs
            const fields = {
                zenodo_url: 'zenodo-url-cell',
                github_url: 'github-url-cell',
                community: 'community-cell',
                ci: 'ci-cell',
                documentation: 'documentation-cell',
                history: 'history-cell',
                issues: 'issues-cell',
                license: 'license-cell',
                unittest: 'unittest-cell',
                codegen_estimation: 'codegen-cell',
                ai_detected: 'ai-detected-cell',
                category: 'category-cell',
                types: 'types-cell',
                findable: 'findable-cell',
                accessible: 'accessible-cell',
                interoperable: 'interoperable-cell',
                reusable: 'reusable-cell',
                overall_fairness: 'overall-fairness-cell',
                howfairis_score: 'howfairis-cell'
            };

            form.addEventListener('submit', async function (e) {
                e.preventDefault();
                startSearchLoadingAnimation();

                form.classList.remove('was-validated');
                resultBox.innerHTML = '';
                dashboard.classList.add('d-none');

                const url = urlInput.value.trim();
                if (!/^https?:\/\/(github\.com|zenodo\.org)\//.test(url)) {
                    urlInput.classList.add('is-invalid');
                    return;
                }
                urlInput.classList.remove('is-invalid');

                //spinner.classList.remove('d-none');

                try {
                    const response = await fetch("{% url 'RSEMM:estimate_maturity' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify({ url })
                    });


                    const data = await response.json();
                    if (!response.ok) {
                        // Django returns {error: "..."} on 400
                        throw new Error(data.error || response.statusText);
                    }

                    // show the numeric score/message
                    resultBox.innerHTML = `
                            <div class="alert alert-info">
                              <strong>Maturity Score:</strong> ${data.HighLevelEstimation.score} / 100<br>
                              <small class="text-muted">${data.HighLevelEstimation.message || ''}</small>
                            </div>

                            <div id="recommendation-wrapper" class="card mt-3 shadow-sm border-0" style="display: none; margin-bottom:10px;">
                              <div class="card-body bg-light">
                                <h5 class="card-title mb-3 text-primary">Recommendations:</h5>
                                <pre id="recommendation-content" class="mb-0" style="white-space: pre-wrap; font-size: 0.8rem; font-family: 'Poppins', sans-serif;"></pre>
                              </div>
                            </div>
                            `;

                    const recommendationText = data.HighLevelEstimation.recommendation;
                    const recommendationBox = document.getElementById('recommendation-wrapper');
                    const recommendationContent = document.getElementById('recommendation-content');

                    if (recommendationText && recommendationBox && recommendationContent) {
                        recommendationContent.textContent = recommendationText;
                        recommendationBox.style.display = 'block';
                    } else {
                        recommendationBox.style.display = 'none';  // fallback if empty
                    }


                    const citations = data.HighLevelEstimation?.citations?.citations || [];

                    if (citations.length > 0) {
                        const citationHtml = citations.map(c => {
                            const year = c.year ? `(${c.year}). ` : "";
                            const title = c.title ? `<i>${c.title}</i>` : "Untitled";
                            const url = c.doi ? `<a href="${c.doi}" target="_blank" title="Open citation"><i class="fas fa-external-link-alt ms-1"></i></a>` : "";

                            return `<li style="margin-bottom: 0.5rem;">
                                ${year}${title} ${url}
                            </li>`;
                                            }).join("");

                                            resultBox.innerHTML += `
                            <div id="citation-wrapper" class="card mt-3 shadow-sm border-0" style="margin-bottom:20px;">
                                <div class="card-body bg-light">
                                    <h5 class="card-title mb-3 text-primary">Citations (${citations.length} found):</h5>
                                    <ul style="padding-left: 1.2rem; font-size: 0.8rem; list-style-type: disc;">
                                        ${citationHtml}
                                    </ul>
                                </div>
                            </div>
                        `;
                    }





                    // populate the dashboard table
                    for (const [key, cellId] of Object.entries(fields)) {
                        document.getElementById(cellId).textContent = data.HighLevelEstimation[key] ?? '–';
                    }
                    dashboard.classList.remove('d-none');
                    // Create or reuse the JSON editor instance
                    if (!window.detailedJsonEditor) {
                        const container = document.getElementById('jsoneditor');
                        const options = {
                            mode: 'view', // other options: 'tree', 'code', 'form'
                            mainMenuBar: false,
                            navigationBar: true
                        };
                        window.detailedJsonEditor = new JSONEditor(container, options);
                    }

                    // OPTIONAL: if you want to display only selected keys (cleaner):
                    /*
                    const selectedDetails = {
                        'repo-profile': data.DetailedEstimation['repo-profile'],
                        'fair-assessment': data.DetailedEstimation['fair-assessment']
                    };
                    window.detailedJsonEditor.set(selectedDetails);
                    */

                    // Full version → display the entire object:
                    window.detailedJsonEditor.set(data.DetailedEstimation);
                } catch (err) {
                    resultBox.innerHTML = `
                            <div class="alert alert-danger">
                              <strong>Error:</strong> ${err.message}
                            </div>`;
                } finally {
                    stopSearchLoadingAnimation();
                }
            });
        })();

        async function loadStoredRecords() {
            try {
                startSearchLoadingAnimation();
                const response = await fetch("{% url 'RSEMM:list_stored_zenodo_records' %}");
                const data = await response.json();
                const tableBody = document.querySelector('#stored-records-table tbody');
                tableBody.innerHTML = '';

                data.records.forEach(rec => {
                    // Safe truncate long texts
                    function truncate(text, maxLength) {
                        return text.length > maxLength ? text.substring(0, maxLength - 3) + '...' : text;
                    }

                    const row = `
                <tr>
                    <td>${rec.zenodo_url ? ` <button class="btn btn-sm btn-primary load-record-btn" data-filename="${rec.filename}"> Load</button>` : '-'}</td>
                    <td>${rec.zenodo_url ? `<a href="${rec.zenodo_url}" target="_blank">URL</a>` : '-'}</td>
                    <td>${rec.github_url ? `<a href="${rec.github_url}" target="_blank">URL</a>` : '-'}</td>
                    <td>${truncate(rec.title, 20)}</td>
                    <td>${truncate(rec.authors, 20)}</td>
                    <td>${truncate(rec.affiliations, 20)}</td>
                    <td>${truncate(rec.topics, 20)}</td>
                    <td>${rec.score}</td>
                </tr>`;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });

                if (!$.fn.dataTable.isDataTable('#stored-records-table')) {
                    $('#stored-records-table').DataTable({
                        "order": [[6, "desc"]],
                        "pageLength": 10,
                        "columnDefs": [
                            { "width": "3%", "targets": 0 },  // load
                            { "width": "5%", "targets": 1 },  // Zenodo
                            { "width": "5%", "targets": 2 },  // GitHub
                            { "width": "10%", "targets": 3 },  // Title
                            { "width": "10%", "targets": 4 },  // Authors
                            { "width": "10%", "targets": 5 },  // Affiliations
                            { "width": "10%", "targets": 6 },  // Topics
                            { "width": "2%", "targets": 7 }    // Score
                        ]
                    });
                }
            } catch (err) {
                console.error('Error loading stored records:', err);
            } finally {
                stopSearchLoadingAnimation();
            }
        }

        document.addEventListener('DOMContentLoaded', loadStoredRecords);


        // Listen for clicks on load buttons
        document.addEventListener('click', async function (e) {
            if (e.target && e.target.classList.contains('load-record-btn')) {
                const filename = e.target.getAttribute('data-filename');

                try {
                    const response = await fetch(`/RSEMM/load_stored_record/${filename}/`);
                    const data = await response.json();

                    if (data.error) {
                        alert('Error: ' + data.error);
                        return;
                    }

                    // Fill dashboard exactly like in estimate_maturity
                    const fields = {
                        zenodo_url: 'zenodo-url-cell',
                        github_url: 'github-url-cell',
                        community: 'community-cell',
                        ci: 'ci-cell',
                        documentation: 'documentation-cell',
                        history: 'history-cell',
                        issues: 'issues-cell',
                        license: 'license-cell',
                        unittest: 'unittest-cell',
                        codegen_estimation: 'codegen-cell',
                        ai_detected: 'ai-detected-cell',
                        category: 'category-cell',
                        types: 'types-cell',
                        findable: 'findable-cell',
                        accessible: 'accessible-cell',
                        interoperable: 'interoperable-cell',
                        reusable: 'reusable-cell',
                        overall_fairness: 'overall-fairness-cell',
                        howfairis_score: 'howfairis-cell'
                    };

                    // Show score
                    const resultBox = document.getElementById('result');
                    resultBox.innerHTML = `
                    <div class="alert alert-info">
                        <strong>Maturity Score:</strong> ${data.HighLevelEstimation.score} / 100<br>
                        <small class="text-muted">${data.HighLevelEstimation.message || ''}</small>
                    </div>

                    <div id="recommendation-wrapper" class="card mt-3 shadow-sm border-0" style="display: none; margin-bottom:10px;">
                      <div class="card-body bg-light">
                        <h5 class="card-title mb-3 text-primary">Recommendations:</h5>
                        <pre id="recommendation-content" class="mb-0" style="white-space: pre-wrap; font-size: 0.8rem; font-family: 'Poppins', sans-serif;"></pre>
                      </div>
                    </div>
                    <br>
                    `;

                    const recommendationText = data.HighLevelEstimation.recommendation;
                    const recommendationBox = document.getElementById('recommendation-wrapper');
                    const recommendationContent = document.getElementById('recommendation-content');

                    if (recommendationText && recommendationBox && recommendationContent) {
                        recommendationContent.textContent = recommendationText;
                        recommendationBox.style.display = 'block';
                    } else {
                        recommendationBox.style.display = 'none';  // fallback if empty
                    }


                    // Fill dashboard fields
                    for (const [key, cellId] of Object.entries(fields)) {
                        document.getElementById(cellId).textContent = data.HighLevelEstimation[key] ?? '–';
                    }

                    // Show dashboard
                    const dashboard = document.getElementById('dashboard');
                    dashboard.classList.remove('d-none');

                    // JSON editor
                    if (!window.detailedJsonEditor) {
                        const container = document.getElementById('jsoneditor');
                        const options = {
                            mode: 'view',
                            mainMenuBar: false,
                            navigationBar: true
                        };
                        window.detailedJsonEditor = new JSONEditor(container, options);
                    }

                    window.detailedJsonEditor.set(data.DetailedEstimation);

                } catch (err) {
                    console.error('Error loading stored record:', err);
                    alert('Error loading stored record.');
                }
            }
        });

        //-------------------------------------------------------------------------------------------------------- Animation
        // Variables for the search overlay animation
        let searchNetworkCanvas, searchCtx, searchNodes = [], searchAnimationId;
        const totalSearchNodes = 100; // 100 nodes
        //----------------------------------------------------------------
        // Initialize the canvas and create 100 nodes at random positions
        function initSearchNetwork() {
            searchNetworkCanvas = document.getElementById('searchNetworkCanvas');
            searchCtx = searchNetworkCanvas.getContext('2d');
            searchNetworkCanvas.width = window.innerWidth;
            searchNetworkCanvas.height = window.innerHeight;

            searchNodes = [];
            for (let i = 0; i < totalSearchNodes; i++) {
                searchNodes.push({
                    x: Math.random() * searchNetworkCanvas.width,
                    y: Math.random() * searchNetworkCanvas.height,
                    vx: (Math.random() - 0.5) * 1,
                    vy: (Math.random() - 0.5) * 1,
                    radius: 3 + Math.random() * 3
                });
            }
        }
        //----------------------------------------------------------------

        // Animate the nodes and draw connecting lines
        function animateSearchNetwork() {
            searchCtx.clearRect(0, 0, searchNetworkCanvas.width, searchNetworkCanvas.height);

            // Update and draw each node
            searchNodes.forEach(node => {
                node.x += node.vx;
                node.y += node.vy;

                // Bounce off edges
                if (node.x < 0 || node.x > searchNetworkCanvas.width) node.vx *= -1;
                if (node.y < 0 || node.y > searchNetworkCanvas.height) node.vy *= -1;

                searchCtx.beginPath();
                searchCtx.arc(node.x, node.y, node.radius, 0, 2 * Math.PI);
                searchCtx.fillStyle = "#00aaff"; // Blue color for nodes
                searchCtx.fill();
            });

            // Draw connecting lines for nodes within a threshold distance
            for (let i = 0; i < searchNodes.length; i++) {
                for (let j = i + 1; j < searchNodes.length; j++) {
                    let dx = searchNodes[i].x - searchNodes[j].x;
                    let dy = searchNodes[i].y - searchNodes[j].y;
                    let distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance < 150) { // threshold for connection
                        searchCtx.beginPath();
                        searchCtx.moveTo(searchNodes[i].x, searchNodes[i].y);
                        searchCtx.lineTo(searchNodes[j].x, searchNodes[j].y);
                        let alpha = 1 - distance / 150;
                        searchCtx.strokeStyle = `rgba(0,170,255,${alpha})`;
                        searchCtx.lineWidth = 0.5;
                        searchCtx.stroke();
                    }
                }
            }

            searchAnimationId = requestAnimationFrame(animateSearchNetwork);
        }
        //----------------------------------------------------------------
        // Start the search splash screen animation
        function startSearchLoadingAnimation() {
            const searchOverlay = document.getElementById('searchLoadingOverlay');
            searchOverlay.style.display = 'block';
            initSearchNetwork();
            animateSearchNetwork();
            startTypingMessage();
        }
        //----------------------------------------------------------------
        // Stop and hide the search splash screen animation
        function stopSearchLoadingAnimation() {
            const searchOverlay = document.getElementById('searchLoadingOverlay');
            searchOverlay.style.display = 'none';
            cancelAnimationFrame(searchAnimationId);
        }
        //----------------------------------------------------------------
        // Example: Modify your search button click handler to use the new splash screen
        document.getElementById('search-button').addEventListener('click', function () {
            const problemStatement = document.getElementById('problem-statement').value.trim();
            if (!problemStatement) {
                alert("⚠️ Please enter a problem statement.");
                return;
            }

            // Check if the problem statement hasn't changed since the last search.
            if (problemStatement === lastProblemStatement) {
                alert("Your search query hasn't changed. Please modify your query before searching again.");
                return;
            }

            // Update the global variable with the new query.
            lastProblemStatement = problemStatement;

            // Start the custom search splash screen
            startSearchLoadingAnimation();

            // Disable the search button during processing
            const searchButton = document.getElementById('search-button');
            searchButton.disabled = true;
            searchButton.innerText = "Searching...";

            // Perform your fetch/search operation
            fetch('/SoftwarePackageSelection/search-recommendation/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ problem_statement: problemStatement })
            })
                .then(response => response.json())
                .then(data => {
                    // Stop the loading animation
                    stopSearchLoadingAnimation();

                    // Re-enable the search button
                    searchButton.disabled = false;
                    searchButton.innerText = "Search";

                    if (data.status === 'success') {
                        displayResults(data.ranked_noun_phrases, data.recommended_packages, data.recommended_repositories);
                    } else {
                        alert(`❌ Error: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("⚠️ Unable to fetch data. Please try again.");
                    stopSearchLoadingAnimation();
                    searchButton.disabled = false;
                    searchButton.innerText = "Search";
                });
        });
        function startTypingMessage() {
            const text = "I'm processing your request…\nPlease be patient – the reasoning process might take a few seconds.";
            const messageElement = document.getElementById("searchTypingMessage");
            messageElement.innerHTML = ""; // clear previous message

            let i = 0;
            const typingSpeed = 50; // ms per char

            function typeWriter() {
                if (i < text.length) {
                    const char = text.charAt(i);
                    if (char === "\n") {
                        messageElement.innerHTML += "<br>";
                    } else {
                        messageElement.innerHTML += char;
                    }
                    i++;
                    setTimeout(typeWriter, typingSpeed);
                } else {
                    // Blinking cursor
                    messageElement.innerHTML += '<span id="cursor"></span>';
                }
            }

            typeWriter();
        }

        //-------------------------------------------------------------------------------------------------

    </script>


</body>
</html>